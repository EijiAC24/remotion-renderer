name: Render Shorts (AutomateShorts)

on:
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Unique job identifier'
        required: true
        type: string
      composition:
        description: 'Remotion composition ID (e.g., TriviaShort)'
        required: true
        type: string
        default: 'TriviaShort'
      props_base64:
        description: 'Remotion props (Base64 encoded JSON)'
        required: true
        type: string
      duration:
        description: 'Video duration in seconds'
        required: true
        type: string
      post_content:
        description: 'SNS post content (Base64 encoded)'
        required: true
        type: string
      platforms_json:
        description: 'Platforms config (Base64 encoded JSON array)'
        required: true
        type: string

jobs:
  render:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Prepare props
        run: echo "${{ inputs.props_base64 }}" | base64 -d > props.json

      - name: Render video
        run: |
          FRAMES=$(((${{ inputs.duration }} * 30) - 1))
          npx remotion render ${{ inputs.composition }} out/video.mp4 \
            --props=props.json \
            --frames=0-${FRAMES} \
            --codec=h264 \
            --crf=18

      - name: Post to SNS
        run: node scripts/post-late.js
        env:
          LATE_API_KEY: ${{ secrets.LATE_API_KEY }}
          POST_CONTENT_B64: ${{ inputs.post_content }}
          PLATFORMS_JSON_B64: ${{ inputs.platforms_json }}
          JOB_ID: ${{ inputs.job_id }}

      - name: Upload artifact (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-render-${{ inputs.job_id }}
          path: |
            out/
            props.json
          retention-days: 7
